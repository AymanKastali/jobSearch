{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"> {% block scripts %}{% endblock scripts %}

    <title>Chat</title>
</head>

<body style="background-color: rgb(245, 245, 245)">
    {% include 'navbar.html' %}
    <div class="container">
        <div class="card shadow col-8 offset-2">
            <div class="card-body">
                <div class="d-flex" style="align-items: center;">
                    <img width="60px" height="60px" style="border-radius: 500px; margin-right: 10px;" src="{{ user.profile.pic.url }}" alt="">
                    <h1>{{ user.profile.name }}</h1>
                </div>
                <hr>
                <div style="margin-bottom: 10px;" class="card shadow-sm">
                    <div class="card-body" style="overflow-y: auto; height: 350px;"  id="messageBody">
                        <div id="chat-messages">
                            {% for message in messages %}
                            <div>
                                <b>{{ message.from_user.profile.name }}</b><br>
                                <small>{{message.message}}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <form id="form" action="" class="d-flex">
                    <input class="form-control" type="text" name="message" id="chat-message-input" placeholder="Message">
                    <button class="btn btn-sm btn-outline-success" type="submit" id="chat-message-submit"><i class="bi bi-send"></i></button>
                </form>
                <div id="messages"></div>
            </div>
        </div>
    </div>
    {{ user.id|json_script:'json-userId' }}
    {{ request.user.profile.name|json_script:'json-username' }}
    {{ request.user.id|json_script:'json-user' }}
    <script type="text/javascript" src="{% static 'js/script.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var messageBody = document.querySelector('#messageBody');
        messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
        const userId = JSON.parse(document.getElementById('json-userId').textContent)
        const username = JSON.parse(document.getElementById('json-username').textContent)
        const requestUser = JSON.parse(document.getElementById('json-user').textContent)
        console.log(requestUser)
        console.log(userId)
        let url = 'ws://' + window.location.host + '/ws/' + userId + '/'
        const chatSocket = new WebSocket(url)
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data)
            if (data.message) {
                let html = `<div><b>${data.username}</b><br>`
                html += `<small>${data.message}</small></div>`
                document.querySelector('#chat-messages').innerHTML += html

            } else {
                alert('Empty message!')
            }
        }
        document.querySelector('#chat-message-submit').onclick = function(e) {
                e.preventDefault()
                const messageInputDom = document.querySelector('#chat-message-input')
                const message = messageInputDom.value
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'username': username,
                    'userId': userId,
                    'requestUser': requestUser,
                }))
                messageInputDom.value = ''
                return false
            }
            // let url = `ws://${window.location.host}/ws/socket-server/`
            // const chatSocket = new WebSocket(url)

        // chatSocket.onmessage = function(e) {
        //     let data = JSON.parse(e.data)
        //     console.log('DATA', data)
        //     if (data.type === 'chat') {
        //         let messages = document.getElementById('messages').innerText += `${data.message} \n`
        //     }
        // }

        // let form = document.getElementById('form')
        // form.addEventListener('submit', (e) => {
        //     e.preventDefault()
        //     let message = e.target.message.value
        //     chatSocket.send(JSON.stringify({
        //         'message': message
        //     }))
        //     form.reset()
        // })
    </script>

</body>

</html>